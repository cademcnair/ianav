<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/default.css">
    <link rel="preload" as="image" href="img/logo.svg">
    <link rel="prefetch" as="image" href="img/map.png">
    <title>IA NAV</title>
</head>
<body>
    <div class="back">
        <div class="content">
            <a href="./index.html" class="home">
                Home Page
                <img class="pheonix" role="presentation" alt="Image by catalyststuff on Freepik" src="img/logo.svg" />
            </a>
            <div class="write"></div>
        </div>
    </div>
    <script src="js/typewriter.js"></script>
    <script src="js/cookies.js"></script>
    <script async>
        const SERVER = "http://localhost:4000"
        async function legal () {
            await write([
                "h2,b", "Legal Agreement",
                "b,i", "Privacy Policy - ",
                "a", "This website does not collect, sell, or distribute any of your information.",
                "br", "",
                "br", "",
                "b,i", "Terms of Service - ",
                "a", "As a user, you will not use this website with malicious intent. This website reserves the right to deny service to any user for any reason.",
                "br", "",
                "br", "",
                "b,i", "Cookie Notice - ",
                "a", "This website does not use cookies.",
                "br", "",
                "br", ""
            ])
            await confirm("I understand my rights and accept these responsibilities.")
            localStorage.setItem("legal", true)
            welcome()
        }
        async function welcome() {
            await write([
                "h2,b", "ðŸŽ‰ We're happy you're here.",
                "a.bottom-room", "Want to hurry up? Change the typewriter speed:",
            ])
            switch(await select([
                "0.75x current",
                "1x current",
                "1.5x current",
                "2x current",
                "4x current",
                "Instant"
            ], global_speed)) {
                case 0: global_speed = 10; break;
                case 1: global_speed = 8; break;
                case 2: global_speed = 6; break;
                case 3: global_speed = 4; break;
                case 4: global_speed = 2; break;
                case 5: global_speed = 0; break;
            }
            localStorage.setItem("speed", global_speed)
            await write([
                "p", "What type of user are you? Please select:"
            ], "false")
            const type = await select([
                "Visitor",
                "Student",
                "Just curious"
            ], global_speed)
            localStorage.setItem("type", type)
            if (type == 0) await write([
                "p", "Welcome to IA!"
            ], "false")
            await write([
                "p", "Would you like to take a (~1 minute) tutorial? It's highly recommended:"
            ], "false")
            const learn = !Boolean(await select([
                "Yes", "No"
            ], global_speed))
            if (type == 1) {
                await write([
                    "p", "Seems like you are a student. Do you want to enter your schedule:"
                ], "false")
                if(!Boolean(await select([
                    "Yes", "No"
                ], global_speed))) {
                    await schedule()
                }
            }
            await write([
                "p", `You can change your settings or ${learn ? "redo" : "complete"} the tutorial anytime by clicking on the \"Settings\" button.`
            ], "false")
            if (learn == false) {
                await confirm("Access the application")
                home(); return;
            } else {
                await confirm("Continue to tutorial")
            }
            await write([
                "h2,b", "ðŸ“š Learning center",
                "p", "This website allows you to navigate Innovation Academy. Input your current location and desired location, then follow the generated path.",
                "p", "The directions generated by this system refer to these terms:",
                "img#img/map.png",
                "p", "For example, if the directions say to \"Go towards the BUS LOOP\", then go north until you no longer can."
            ], "true")
            await confirm("Continue?")
            await write([
                "h2,b", "ðŸ“š Learning center",
            ], "true", 0)
            await write([
                "p", "There are also some general locations you need to know.",
                "b,i", "HANGER - ",
                "a", "Big cafeteria on the first floor",
                "br", "",
                "br", "",
                "b,i", "EXCHANGE 2 - ",
                "a", "The library on the second floor (connects the two sides of the floor)",
                "br", "",
                "br", "",
                "b,i", "EXCHANGE 3 - ",
                "a", "The library on the third floor (connects the two sides of the floor)",
                "br", "",
                "br", "",
                "b,i", "FINAL TIP - ",
                "a", "If a direction says to stop at a landmark, stop next to the landmark and not just when you see it",
                "br", "",
                "br", "",
            ], "false")
            await confirm("Access the application"); home();
        }
        let full_schedule = [
            "First period", "Second period",
            "Third period", "Fourth period",
            "Fifth period", "Sixth period",
            "Seventh period", "Eigth period"
        ]
        const places = [
            "hanger", "exchange 3",
            "exchange 2", "front", "back"
        ]
        async function schedule() {
            await write([
                "h2,b", "ðŸ‘¨â€ðŸ« Schedule center",
                "p", "When is your lunch period:"
            ], "true")
            let remaining = [
                "First period", "Second period",
                "Third period", "Fourth period",
                "Fifth period", "Sixth period",
                "Seventh period", "Eigth period"
            ]
            let schedule = [null, null, null, null, null, null, null, null]
            const lunch_pos = 3 + await select([
                "Fourth period",
                "Fifth period"
            ], global_speed)
            schedule[lunch_pos] = "Lunch"
            remaining.splice(lunch_pos, 1)
            await write([
                "p", "How many virtural periods do you have?"
            ], "prevlog")
            let virtural = await input(
                "Enter a number (1-7)",
                [(i) => !isNaN(Number(i)),
                 (i) => i >= 1 && i <= 7],
                "a number 1-7"
            )
            const total_virtural = virtural
            while (virtural != 0) {
                await write([
                    "p", `When is your virtural period (${total_virtural-(--virtural)}/${total_virtural}):`
                ], "false", 0)
                const vir_pos = await select(remaining, global_speed)
                schedule[full_schedule.indexOf(remaining[vir_pos])] = "Virtural"
                remaining.splice(vir_pos, 1)
            }
            await write([
                "p", "Let's enter the room numbers for your remaining periods."
            ], "false")
            await confirm("Continue?")
            await write([
                "h2,b", "ðŸ‘¨â€ðŸ« Schedule center",
                "p,i", "The hanger, exchange 2, exchange 3, front and back can be entered as locations!"
            ], "true")
            for (const period of remaining) {
                await write([
                    "p", `What is your ${period.toLowerCase()}'s location?`
                ], "prevlog")
                schedule[full_schedule.indexOf(period)] = await input("Enter a room number", [(i) => i.match(/[123][1-9]{2}(.[123])?/) != null || places.includes(i.toLowerCase())], "a valid room number")
            }
            console.log(schedule)
            localStorage.setItem("schedule", JSON.stringify(schedule))
        }
        async function home() {
            await write([
                "h2,b", "ðŸ¡ Home page",
                "p", "What would you like to do:"
            ], "true")
            const selected = await select([[
                "Settings",
                "Navigate"
            ], localStorage.getItem("type") == 1 ? ["View schedule"] : []].flat(), global_speed)
            if (selected == 0) {
                welcome(); return;
            }
            if (selected == 1) {
                let input_type = 0
                let from = to = 0;
                if (localStorage.getItem("type") == 1 && localStorage.getItem("schedule")) {
                    const rooms = JSON.parse(localStorage.getItem("schedule"))
                    await write([
                        "p", "Select an option for navigation:"
                    ], "false")
                    const options = [
                        "Custom"
                    ]
                    const n = (i) => !isNaN(Number(i))
                    let one = 0, two = 1;
                    const pres = ["1st", "2nd", "3rd", "4th", "5th", "6th", "7th", "8th"]
                    let items = []
                    while (one != 8) {
                        if (n(rooms[one]) && n(rooms[two])) {
                            options.push(`From ${pres[one]} to ${pres[two]}`)
                            items.push([one, two])
                        }
                        one++; two++
                    }
                    if (options.length > 1) {
                        let selected = await select(options, global_speed)
                        input_type = selected
                        if (--selected != -1) {
                            from = rooms[items[selected][0]]
                            to = rooms[items[selected][1]]
                            const from_request = await fetch(`${SERVER}/${from}`)
                            if (from_request.ok) {
                                from = await from_request.text()
                            } else {
                                await write([
                                    "h2,p", "ðŸ¤¦â€â™‚ï¸ Error center",
                                    "p,b", `Your ${pres[items[selected][0]]} period room number (${from}) is not in our database`,
                                ])
                                await confirm("Home page")
                                home(); return;   
                            }
                            const to_request = await fetch(`${SERVER}/${to}`)
                            if (to_request.ok) {
                                to = await to_request.text()
                            } else {
                                await write([
                                    "h2,p", "ðŸ¤¦â€â™‚ï¸ Error center",
                                    "p,b", `Your ${pres[items[selected][1]]} period room number (${to}) is not in our database`,
                                ])
                                await confirm("Home page")
                                home(); return;   
                            }
                        }
                    }
                }
                if (input_type == 0) {
                    await write([
                        "p,i", "The hanger, exchange 2, exchange 3, front and back can be entered as locations!",
                        "p", "What is your current room number?"
                    ], "prevlog")
                    await input("Enter valid room number", [
                        (i) => {
                            return i.match(/[123][1-9]{2}(.[123])?/) != null || places.includes(i.toLowerCase())},
                        async (i) => {
                            const request = await fetch(`${SERVER}/${i}`)
                            if (request.ok) {
                                from = await request.text()
                            }
                            return !request.ok 
                        }
                    ], "a vaild and existing room number")
                    await write([
                        "p", "What is your destination room number?"
                    ], "prevlog")
                    await input("Enter valid room number", [
                        (i) => i.match(/[123][1-9]{2}(.[123])?/) != null || places.includes(i.toLowerCase()),
                        async (i) => {
                            const request = await fetch(`${SERVER}/${i}`)
                            if (request.ok) {
                                to = await request.text()
                            }
                            return !request.ok
                        }
                    ], "a vaild and existing room number")
                }
                const request = await fetch(`${SERVER}/${from}/${to}`)
                if (!request.ok) {
                    await write([
                        "h2,p", "ðŸ¤¦â€â™‚ï¸ Error center",
                        "p,b", "Failed to find path",
                    ])
                    await confirm("Home page")
                    home(); return;
                }
                const data = await request.json()
                await write([
                    "p,b", data.time
                ], "false")
                await confirm("View path")
                // console.log(data, data.directions)
                // console.log(data.directions.map((i, d) => ["i.dir", 
                //     `${d+1}.  ` + (Array.isArray(i)
                //                 ? i.length == 3
                //                     ? `Facing the ${i[0]}, go down the hallway and enter room ${i[1]} on your ${i[2]}`
                //                     : `Exit the room and go down the hallway to your ${i[0]}`
                //                 : String(i))
                // ]))

                await write([[
                    "h2,b", "ðŸ—º Navigation center"
                ], ...(data.path[0] == "1-2"
                 ? ["i.dir", "Start in the school lobby facing the BUS LOOP", "br", "", "br", ""]
                 : data.path[0] == "1-59"
                 ? ["i.dir", "Start next to the lost and found", "br", "", "br", ""]
                 : data.path[0] == "1-77"
                 ? ["i.dir", "Start right in front of the large staircase", "br", "", "br", ""]
                 : data.path[0] == "2-1"
                 ? ["i.dir", "Start right in front of the large staircase but stay in the EXCHANGE 2", "br", "", "br", ""]
                 : data.path[0] == "3-1"
                 ? ["i.dir", "Start ring in front of the small staircase but stay in the EXCHANGE 3", "br", "", "br", ""] : [])
                , ...data.directions.map((i, d) => ["i.dir", 
                    `${d+1}.  ` + (Array.isArray(i)
                                ? i.length == 3
                                    ? `Facing the ${i[0]}, go down the hallway and enter room ${i[1]} on your ${i[2]}`
                                    : `Exit the room and go down the hallway to your ${i[0]}`
                                : String(i)),
                "br", "", "br", ""])].flat(), "true")
                await confirm("Return home")
                home(); return;
            }
            if (selected == 2) {
                if (localStorage.getItem("schedule")) {
                    await write([
                        "h2,b", "ðŸ‘¨â€ðŸ« Schedule center",
                    ], "true")
                    await write(JSON.parse(localStorage.getItem("schedule")).map((i, d) => ["i.dir", `${full_schedule[d]}: ${i}`, "br", ""]).flat(), "false")
                    await write([
                        "p,b", "Would you like to change your schedule?"
                    ], "false")
                } else {
                    await write([
                        "p", "You do not have a schedule. Would you like to create one?"
                    ], "false")
                }
                if(await select([
                    "Yes, take me there",
                    "No, take me home"
                ], global_speed) == 0) await schedule()
                home(); return;
            }
        }
        (
            !localStorage.getItem("legal") ? legal :
            !localStorage.getItem("type") ? welcome : home
        )()
    </script>
</body>
</html>